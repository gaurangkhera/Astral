{% extends 'base.html' %}
{% block content %}
    <!-- Content -->
<div class="relative h-screen">
    <div class="max-w-4xl px-4 py-10 sm:px-6 lg:px-8 lg:py-14 mx-auto">
      <!-- Title -->
      <div class="text-center">
  
        <h1 class="text-3xl font-bold text-gray-800 sm:text-4xl :text-white">
          Nuxeland Guru
        </h1>
        <p class="mt-3 text-gray-600 :text-gray-400">
          Your AI-powered assistant.
        </p>
      </div>
      <!-- End Title -->
  
      <ul id="message-container">
            {% for i in messages %}
            {% if i.role == 'user' %}
            <li class="max-w-2xl ml-auto flex my-4 justify-end gap-x-2 sm:gap-x-4">
                <div class="grow text-end space-y-3">
                  <!-- Card -->
                  <div class="inline-block bg-[#234E36] rounded-lg p-4 shadow-sm">
                    <p class="text-sm text-white">
                      {{i.content}}
                    </p>
                  </div>
                  <!-- End Card -->
                </div>
        
                <button class="relative block p-2 text-gray-700 bg-white w-10 h-10 border rounded-full">
                    {{current_user.username[0]}}
                </button>
              </li>
              {% else %}
              <li class="flex gap-x-2 sm:gap-x-4 my-4">
                <button class="relative block p-2 text-gray-700 bg-white w-10 h-10 border rounded-full">
                    <i data-lucide="bot"></i>
                </button>
        
                <div class="grow max-w-[90%] md:max-w-2xl w-full space-y-3">
                    <!-- Card -->
                    <div class="bg-white border border-gray-200 rounded-lg p-4 space-y-3 :bg-slate-900 :border-gray-700">
                    <p class="text-sm text-gray-800 :text-white">
                        {{i.content}}
                    </p>
                </div>
                </li>
            {% endif %}
            {% endfor %}
      </ul>
    </div>
  
    <!-- Search -->
    <footer class="max-w-4xl mx-auto sticky bottom-0 z-10 bg-white border-t border-gray-200 pt-2 pb-4 sm:pt-4 sm:pb-6 px-4 sm:px-6 lg:px-0 :bg-slate-900 :border-gray-700">
  
      <!-- Input -->
      <div class="relative">
        <form id="question-form">
            <input class="p-4 pb-12 block w-full border-gray-200 rounded-md text-sm border border-[#234E36] focus:border-none focus:ring[#234E36] focus:outline-[#234E36] :bg-slate-900 :border-gray-700 :text-gray-400" placeholder="Ask me anything..." id="user-question" required />
        </form>
  
        <!-- Toolbar -->
        <div class="absolute bottom-px inset-x-px p-2 rounded-b-md bg-white :bg-slate-900">
          <div class="flex justify-between items-center">
            <!-- Button Group -->
            <div class="flex items-center">
              <!-- Mic Button -->
              <button type="button" class="inline-flex flex-shrink-0 justify-center items-center h-8 w-8 rounded-md text-gray-500 hover:text-blue-600 focus:z-10 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all :hover:text-blue-500 sr-only">
                <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>
                  <path d="M11.354 4.646a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708l6-6a.5.5 0 0 1 .708 0z"/>
                </svg>
              </button>
              <!-- End Mic Button -->
  
              <!-- Attach Button -->
              <button type="button" class="inline-flex flex-shrink-0 justify-center items-center h-8 w-8 rounded-md text-gray-500 hover:text-blue-600 focus:z-10 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all :hover:text-blue-500 sr-only">
                <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M4.5 3a2.5 2.5 0 0 1 5 0v9a1.5 1.5 0 0 1-3 0V5a.5.5 0 0 1 1 0v7a.5.5 0 0 0 1 0V3a1.5 1.5 0 1 0-3 0v9a2.5 2.5 0 0 0 5 0V5a.5.5 0 0 1 1 0v7a3.5 3.5 0 1 1-7 0V3z"/>
                </svg>
              </button>
              <!-- End Attach Button -->
            </div>
            <!-- End Button Group -->
  
            <!-- Button Group -->
            <div class="flex items-center gap-x-1">
              <!-- Mic Button -->
              <button type="button" class="inline-flex flex-shrink-0 justify-center items-center h-8 w-8 rounded-md text-gray-500 hover:text-blue-600 focus:z-10 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all :hover:text-blue-500 sr-only">
                <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z"/>
                  <path d="M10 8a2 2 0 1 1-4 0V3a2 2 0 1 1 4 0v5zM8 0a3 3 0 0 0-3 3v5a3 3 0 0 0 6 0V3a3 3 0 0 0-3-3z"/>
                </svg>
              </button>
              <!-- End Mic Button -->
  
              <!--   Button -->
              <button type="button" class="inline-flex flex-shrink-0 justify-center items-center h-8 w-8 rounded-md text-white bg-[#234E36] :z-10 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                <svg class="h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M15.964.686a.5.5 0 0 0-.65-.65L.767 5.855H.766l-.452.18a.5.5 0 0 0-.082.887l.41.26.001.002 4.995 3.178 3.178 4.995.002.002.26.41a.5.5 0 0 0 .886-.083l6-15Zm-1.833 1.89L6.637 10.07l-.215-.338a.5.5 0 0 0-.154-.154l-.338-.215 7.494-7.494 1.178-.471-.47 1.178Z"/>
                </svg>
              </button>
              <!-- End Send Button -->
            </div>
            <!-- End Button Group -->
          </div>
        </div>
        <!-- End Toolbar -->
      </div>
      <!-- End Input -->
    </footer>
    <!-- End Search -->
  </div>
  <!-- End Content -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    $(document).ready(function() {
      function scrollToBottom() {
        $('#message-container').scrollTop($('#message-container')[0].scrollHeight);
      }
  
      scrollToBottom();
  
      $('#question-form').submit(function(event) {
        event.preventDefault();
        let userQuestion = $('#user-question').val();
        if(userQuestion == ''){
            alert('cant send empty message');
        }
        let userMessage = `
        <li class="max-w-2xl ml-auto flex my-4 justify-end gap-x-2 sm:gap-x-4">
          <div class="grow text-end space-y-3">
            <!-- Card -->
            <div class="inline-block bg-[#234E36] rounded-lg p-4 shadow-sm">
              <p class="text-sm text-white">
                ${userQuestion}
              </p>
            </div>
            <!-- End Card -->
          </div>
  
          <button class="relative block p-2 text-gray-700 bg-white w-10 h-10 border rounded-full">
                    {{current_user.username[0]}}
                </button>
        </li>`;
  
        $('#message-container').append(userMessage);
        $('#user-question').val('');
        scrollToBottom();
  
        $.ajax({
          type: 'POST',
          url: '/ask_question',
          data: { user_question: userQuestion },
          success: function(data) {
            let aiMessage = `
            <li class="flex gap-x-2 sm:gap-x-4 my-4">
                <button class="relative block p-2 text-gray-700 bg-white w-10 h-10 border rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bot w-6 h-6 mr-2"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>
                </button>
    
            <div class="grow max-w-[90%] md:max-w-2xl w-full space-y-3">
                <!-- Card -->
                <div class="bg-white border border-gray-200 rounded-lg p-4 space-y-3 :bg-slate-900 :border-gray-700">
                <p class="text-sm text-gray-800 :text-white">
                    ${data['response']}
                </p>
            </div>
            </li>`;
  
            $('#message-container').append(aiMessage);
            scrollToBottom();
          },
          error: function() {
            let aiErrorMessage = `
              <li class="max-w-2xl ml-auto flex justify-end gap-x-2 sm:gap-x-4">
                <div class="grow text-end space-y-3">
                  <div class="bg-gray-200 text-gray-700 rounded-lg p-4 shadow-sm">
                    Error: Something went wrong.
                  </div>
                </div>
                <span class="flex-shrink-0 inline-flex items-center justify-center h-[2.375rem] w-[2.375rem] rounded-full bg-gray-600">
                  <span class="text-sm font-medium text-white leading-none">AI</span>
                </span>
              </li>`;
  
            $('#message-container').append(aiErrorMessage);
            scrollToBottom();
          }
        });
      });
    });
  </script>
{% endblock content %}